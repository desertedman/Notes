# 3. Machine-Level Representation of Programs

<!--toc:start-->

- [3. Machine-Level Representation of Programs](#3-machine-level-representation-of-programs)
  - [Program Encodings](#program-encodings)
    - [C Compiled Code](#c-compiled-code)
    - [Machine-Level Code](#machine-level-code)
  - [Data Formats](#data-formats)
  - [Accessing Information](#accessing-information)
    - [Operand Specifiers](#operand-specifiers)
    - [Data Movement Instructions](#data-movement-instructions)
  - [End](#end)
  <!--toc:end-->

## Program Encodings

### C Compiled Code

1. _Preprocessor_ expands source code with `#include`s and `#define` macros
2. _Compiler_ generates assembly code in .s files
3. _Assembler_ converts assembly code to binary _object-code_ .o files
4. _Linker_ merges .o files, implements library functions (e.g. `printf`) and generates final executable code

### Machine-Level Code

- _Program Counter_ indicates address of next instruction to execute
- _Register File_ contains 16 registers of 64-bit values
- Condition code registers hold info about most recently executed arithmetic or logical instruction
- Set of vector registers can each hold one or more int or floating-point values

## Data Formats

- Intel _word_ data type - 16 bit data type
  - 32 bit quantity is _double word_
  - 64 bit quantity is _quad word_

| C declaration | Intel data type  | Assembly-code suffix | Size (bytes) |
| ------------- | ---------------- | -------------------- | ------------ |
| char          | Byte             | b                    | 1            |
| short         | Word             | w                    | 2            |
| int           | Double word      | l                    | 4            |
| long          | Quad word        | q                    | 8            |
| char \*       | Quad word        | q                    | 8            |
| float         | Single precision | s                    | 4            |
| double        | Double precision | l                    | 8            |

- `int`s and `double`s use same suffix, but use different code paths for integer and floating-point arithmetic

## Accessing Information

- Numbers refer to which bits can be accessed by register

| 63   | 31    | 15    | 7     | Purpose       |
| ---- | ----- | ----- | ----- | ------------- |
| %rax | %eax  | %ax   | %al   | Return value  |
| %rbx | %ebx  | %bx   | %bl   | Callee saved  |
| %rcx | %ecx  | %cx   | %cl   | 4th argument  |
| %rdx | %edx  | %dx   | %dl   | 3rd argument  |
| %rsi | %esi  | %si   | %sil  | 2nd argument  |
| %rdi | %edi  | %di   | %dil  | 1st argument  |
| %rbp | %ebp  | %bp   | %bpl  | Callee saved  |
| %rsp | %esp  | %sp   | %spl  | Stack pointer |
| %r8  | %r8d  | %r8w  | %r8b  | 5th argument  |
| %r9  | %r9d  | %r9w  | %r9b  | 6th argument  |
| %r10 | %r10d | %r10w | %r10b | Caller saved  |
| %r11 | %r11d | %r11w | %r11b | Caller saved  |
| %r12 | %r12d | %r12w | %r12b | Caller saved  |
| %r13 | %r13d | %r13w | %r13b | Caller saved  |
| %r14 | %r14d | %r14w | %r14b | Caller saved  |
| %r15 | %r15d | %r15w | %r15b | Caller saved  |

### Operand Specifiers

- Instruction operands can be of type:
  - Immediate - constant value
  - Register
  - From memory

| Type      | Form  | Operand value   |
| --------- | ----- | --------------- |
| Immediate | $Imm  | Imm             |
| Register  | %r_a  | R\[r_a\]        |
| Memory    | Imm   | M\[Imm\]        |
| Memory    | (r_a) | M\[R\[Imm\]\*\] |

\* Value in register used as a memory address

- Refer to CSAPP pg. 209 for more Memory forms

### Data Movement Instructions

- Copy data from one location to another
- Cannot copy from one memory location to another; must load source into a register, then write to destination
- `mov src, dest`

| Instruction  | Effect | Description             |
| ------------ | ------ | ----------------------- |
| _MOV S, D_   | D <- S | Move                    |
| movb         |        | Move byte               |
| movw         |        | Move word               |
| movl         |        | Move double word        |
| movq         |        | Move quad word          |
| movabsq I, R | R <- I | Move absolute quad word |

- Ex.
  - `movl $0x4050, %eax` - Immediate--Register, 4 bytes
  - `movw %bp, %sp` - Register--Register, 2 bytes
  - `mov (%rdi, %rcx), %al` - Memory--Register, 1 byte
- `movs` and `movz` family provide extended versions of moved item

## End
